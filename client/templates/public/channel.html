<template name="channel">
    {{#with channel}}
    <div class=playerbody>
      {{#if isModerator}}
      <button id="CloseRoom" type="button" class="btn btn-default">Close Room</button>
      {{/if}}
      <section>
        <div class="headleft">
          <h1 class="roomtitle">{{title}}</h1>
          <h4 class="roomdesc">{{query}}</h4>
          <div class="upnext">
            {{#with nextS}}
              <h3 class="upnextsongname">Up next.. {{title}}</h3>
              <img src="{{thumbnail}}" class="historyQ">
            {{/with}}
          </div>
        </div>

         <div class="headright">
          {{> searchBox}}<p></p>
                    <p><br>


<a href="https://twitter.com/share" class="twitter-share-button" data-text="I am listening to {{title}} on #djcast_" data-via="djcast_">Tweet</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
                    </p>
          {{> suggestionModal}}<p></p>
          {{#if isModerator}}
            {{> qrCode }}
          {{/if}}
          {{> sourceSelect}}

        </div>
      </section>

      {{#with currentSong}}
        <div class="player">
          {{#if isModerator}}
            {{> Moderator videoId=videoID source=source thumbnail=thumbnail}}
          {{else}}
            <img src="{{thumbnail}}" class="playerimg">
          {{/if}}
          <div class="playermeta">
            <h3 class="songname">{{title}}</h3>
          </div>
        </div>
      {{/with}}

    <div class="historyQueue">
      {{#each getRecent}}
        <img src="{{thumbnail}}" class="historyQ">
      {{/each}}
    </div> 
  </div>
	{{/with}}

</template>

<template name="sourceSelect">
  <select id="src">
    <option value="youtube">Youtube</option>
    <option value="soundcloud">SoundCloud</option>
  </select>
</template>

<template name="qrCode">
  <button type="button" class="socialbutton">QR</button>
    <div class="showQr" hidden = "true;">
      {{> QrCode text=getCurrentUrl }}
    </div>
</template>

<template name="searchBox">
  <input type="text" class="search" id="search-box" placeholder="search youtube here">
  <div class="list-group" hidden = "true;">
  {{#each getSearchResults}}
      <a href="#" class="list-group-item">
      <div class="row">
        <div class="col-md-1">
          {{#if isYoutube}}
          <img src="{{snippet.thumbnails.default.url}}" class="img-responsive"/>
          {{else}}
          <img src="{{artwork_url}}" class="img-responsive"/>
          {{/if}}
        </div>
        <div class="col-md-11">
          {{#if isYoutube}}
          <h4 class="list-group-item-heading">{{snippet.title}}</h4>
          {{else}}
          <h4 class="list-group-item-heading">{{title}}</h4>
          {{/if}}
        </div>
      </div>
        </a>
    {{/each}}
    </div>
</template>

<template name="suggestionModal">
<button type="button" id="largeCreate" class="suggestionButton" data-toggle="modal" data-target="#myModal2">Suggestions</button>
<!-- Modal -->
<div class="modal fade" id="myModal2" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="myModalLabel">Suggested Songs

        </h4>
      </div>
      <div class="modal-body" id="modal">
        <form>
          
        </form>
        
      </div>
      <div class="modal-footer">
      </div>
    </div>
  </div>
</div>

</template>

<template name="Moderator">
  <div id="player"></div>
  <br>
  <span style="display: inline;">
    <input id="playPauseButton" class="playskip" type="button" value="Pause" OnClick="playPauseClick()"/>
    <input id="skipButton" class="playskip" type="button" value="Skip"/>
  </span>

  <script type="text/javascript" src="https://connect.soundcloud.com/sdk/sdk-3.0.0.js">
  
  </script>

  <script type="text/javascript">
    function onPlayerStateChange(event) {
      if (event.data == YT.PlayerState.ENDED) {
        var channelId = FlowRouter.getParam('id');
        var song = Song.getLatest(channelId).fetch()[0];
      
        var hist = new History();
        hist.set("title", song.title);
        hist.set("videoID", song.videoID);
        hist.set("thumbnail", song.thumbnail);
        hist.set("source", song.source); 
        hist.set("channelID", song.channelID);
  
        Meteor.call('/history/new', hist, function(err, res){});
        Meteor.call('/song/remove', Song.getLatest(channelId).fetch()[0], function(err, res) { 
          if (err) {}
            if (Song.getLatest(channelId).fetch()[0]) {
              if (Song.getLatest(channelId).fetch()[0].source == 'youtube') {
                player.loadVideoById(Song.getLatest(channelId).fetch()[0].videoID, 0, "default");
                player.playVideo();
              } else {
                sound.pause();
                playSoundcloud();
              }
            }
        });
      }
    }

    function playPauseClick(){
      var button = document.getElementById("playPauseButton");
        if(button.value == "Pause"){
          button.value = "Play";
          if ('{{source}}' == 'youtube')
            player.pauseVideo();
          else
            sound.pause();
        }
        else{
        button.value = "Pause";
        if ('{{source}}' == 'youtube')
          player.playVideo()
        else
          sound.play();
      }

    }
    function playSoundcloud(vid) {
      if (vid) {
        SC.stream('/tracks/' + vid).then(function(player){
        player.play();
        player.on(
          'finish',
          function() {
            var channelId = FlowRouter.getParam('id');
            var song = Song.getLatest(channelId).fetch()[0];
            
            var hist = new History();
            hist.set("title", song.title);
            hist.set("videoID", song.videoID);
            hist.set("thumbnail", song.thumbnail);
            hist.set("source", song.source); 
            hist.set("channelID", song.channelID);
            
            Meteor.call('/history/new', hist, function(err, res){});
            Meteor.call('/song/remove', Song.getLatest(channelId).fetch()[0], function(err, res) { 
              if (err) {}
              if (Song.getLatest(channelId).fetch()[0]) {
                if (Song.getLatest(channelId).fetch()[0].source == 'youtube') {
                  player.loadVideoById(Song.getLatest(channelId).fetch()[0].videoID, 0, "default");
                  player.playVideo();
                } else {
                  player.pause();
                  playSoundcloud(Song.getLatest(channelId).fetch()[0].videoID);
                }
              }
            });
          }
        );
        sound = player;
      });
      } else {
        SC.stream('/tracks/{{videoId}}').then(function(player){
          player.play();
          player.on(
            'finish',
            function() {
              var channelId = FlowRouter.getParam('id');
              var song = Song.getLatest(channelId).fetch()[0];
              
              var hist = new History();
              hist.set("title", song.title);
              hist.set("videoID", song.videoID);
              hist.set("thumbnail", song.thumbnail);
              hist.set("source", song.source); 
              hist.set("channelID", song.channelID);
              
              Meteor.call('/history/new', hist, function(err, res){});
              Meteor.call('/song/remove', Song.getLatest(channelId).fetch()[0], function(err, res) { 
                if (err) {}
                if (Song.getLatest(channelId).fetch()[0]) {
                  if (Song.getLatest(channelId).fetch()[0].source == 'youtube') {
                    player.loadVideoById(Song.getLatest(channelId).fetch()[0].videoID, 0, "default");
                    player.playVideo();
                  } else {
                    player.pause();
                    playSoundcloud(Song.getLatest(channelId).fetch()[0].videoID);
                  }
                }
              });
            }
          );
          sound = player;
        });
      }
    }
  </script>

  {{#if isYoutube source}}

  <script>

  document.getElementById("player").hidden = false;
    var tag = document.createElement('script');
  
    tag.src = "https://www.youtube.com/iframe_api";
    var firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
  
    var player;
    function onYouTubeIframeAPIReady() {
      player = new YT.Player('player', {
        height: '270',
        width: '480',
        videoId: '{{videoId}}',
        playerVars: {
          'autoplay': 1,
          'controls': 0,
          'disablekb': 1,
          'enablejsapi': 1,
          'rel': 0,
        },
        events: {
          'onReady': onPlayerReady,
          'onStateChange': onPlayerStateChange
        }
      });
    }

    function onPlayerReady(event) {
      event.target.playVideo();
    }

  </script>
  {{else}}
  <script type="text/javascript">
    document.getElementById("player").hidden = true;

    var tag = document.createElement('script');
    tag.src = "https://connect.soundcloud.com/sdk/sdk-3.0.0.js";
    tag.type = 'text/javascript';
    var firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

    var sound;
    tag.onload = function() {
      SC.initialize({
        client_id: 'ee340a5bed9ea7336003102356efeaa9'
      });


      playSoundcloud();
    }
  </script>
  <img src="{{thumbnail}}" class="playerimg">
  {{/if}}

  <!--{{> myButtons}}-->
</template>
